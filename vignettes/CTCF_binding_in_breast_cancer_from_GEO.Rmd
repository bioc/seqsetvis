---
title: "CTCF binding in breast cancer cell lines: From GEO"
author: "Joseph R Boyd"
date: "`r Sys.Date()`"
output:
rmarkdown::html_vignette:
fig_caption: yes
vignette: >
%\VignetteIndexEntry{CTCF binding in breast cancer cell lines: From GEO}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

A demonstration of the use of the [seqsetvis](https://github.com/jrboyd/seqsetvis)
package to compare the binding of the transcription factor CTCF across 3 breast 
cancer cell lines.  

This consists of 2 stages:

1. 3-way overlap of CTCF peaks in 3 cell lines to create a single merged regions set with 3 logical attributes.
2. Retrieval of binding profiles around merged regions set.

Both stages are supported by several plotting functions.

## Loading Libraries

```{r, message = F}
library(seqsetvis)
library(magrittr)
library(rtracklayer)
library(cowplot)
```

## Loading narrowPeak files as GRanges

This vignette runs using a small subset of datasets that are publicly available via [GEO](https://www.ncbi.nlm.nih.gov/geo/).  To download the full dataset see: [narrowPeak from GEO](#np_load)

```{r}
# load 
# set filepaths
np_files = c(
    system.file("extdata", "MCF10A_CTCF_random100.narrowPeak", package = "seqsetvis"),
    system.file("extdata", "MCF10AT1_CTCF_random100.narrowPeak", package = "seqsetvis"),
    system.file("extdata", "MCF10CA1_CTCF_random100.narrowPeak", package = "seqsetvis")
)

names(np_files) = np_files %>%
    basename() %>%
    sub("_CTCF_random100.narrowPeak", "", x = .)

# load peak calls
# from: https://charlesjb.github.io/How_to_import_narrowPeak/
extraCols_narrowPeak <- c(signalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
np_grs <- lapply(np_files, function(f){
    import(f, format = "BED",
           extraCols = extraCols_narrowPeak)
})

# # Alternatively, accesss the full datasets by url.
# np_grs <- lapply(CTCF_in_10a_narrowPeak_urls, function(f){
#     import(f, format = "BED",
#            extraCols = extraCols_narrowPeak)
# })

#np_grs is now a valid input for overlapIntervalSets()
#any list (ideally with names set) of GRanges would be fine.
```

```{r}
olaps = overlapIntervalSets(np_grs)
olaps %>% mcols %>% as.data.frame %>% colSums
```
### Subsetting Operations
##### bound in all 3
```{r}
subset(olaps, MCF10A & MCF10AT1 & MCF10CA1) %>% length
```
##### bound in all but MCF10CA1
```{r}
subset(olaps, MCF10A & MCF10AT1 & !MCF10CA1) %>% length
```
##### bound in MCF10CA1 (ignores the other 2)
```{r}
subset(olaps, MCF10CA1) %>% length
```
### Plotting

##### Total number of hits per sample
```{r, hold = TRUE, fig.align='center', fig.height=3}
p1 = setPlotBars(olaps) +  theme(legend.position = "left")
p2 = setPlotPie(olaps) + guides(fill = "none")
p1 = p1 + theme(axis.text.x = element_blank(), 
                axis.ticks.x = element_blank(),
                legend.justification = "center")
cowplot::ggdraw() +
    cowplot::draw_plot(p1, 0, 0, .58, .7) +
    cowplot::draw_plot(p2, 0.45, 0, 0.65, .8) +
    cowplot::draw_plot_label(c("CTCF binding in breast cancer cell lines", "A", "B"),
                             x = c(.04, .25, 0.65),
                             y = c(.92, .8, .8), size = 15, hjust = 0)
```

##### Overlaps between samples

```{r, hold = TRUE, fig.align='center', fig.width=8, fig.height=4}
p1 = setPlotVenn(olaps)  +
    theme(legend.text = element_text(size = 8), 
          legend.position = "left")
p2 = setPlotEuler(olaps) + 
    theme(legend.text = element_text(size = 8)) + 
    guides(fill = "none", color = "none")
p3 = setPlotHeatmap(olaps) + 
    theme(axis.text.x = element_text(size = 8)) + 
    labs(title = "")
cowplot::ggdraw() +
    draw_plot(p1 + theme(legend.justification = "bottom"), 0, 0, .47, 1) +
    draw_plot(p2, 0.43, 0, 0.3, 1) +
    draw_plot(p3, 0.75, 0, .25, 1) +
    draw_plot_label(c("CTCF binding in breast cancer cell lines", "A", "B", "C"),
                    x = c(.04, .12, 0.43, .73),
                    y = c(.92, .8, .8, .8), size = 15, hjust = 0)
```

### Prepare overlap ranges for fetching profiles
```{r, fig.height=3}
width_q75 = olaps %>% width() %>% quantile(., .75)
width_q75 = ceiling(width_q75 / 100) * 100
hist_res = hist(width(olaps))
lines(rep(width_q75, 2), c(0, max(hist_res$counts)), col = "red", lwd = 5)
text(width_q75, max(hist_res$counts), "fixedSize", adj = c(-.1, 1), col = "red")
## apply width
olap_fixedSize = centerFixedSizeGRanges(olaps, width_q75)
```

### Fetch profiles
```{r}
bw_dt = CTCF_in_10a_profiles_dt

# reading bigWigs will not work at all on windows. if you are able to read
# bigwigs on your system, consider the following for loading as bigwigs:
# # alternative (1) accessing the subsetted bigwigs included with this package
# bw_files = sapply(names(CTCF_in_10a_bigWig_urls), function(x){
#     system.file("extdata", paste0(x, "_FE_random100.bw"), package = "seqsetvis")
# })
# bw_dt = fetchWindowedBigwigList(bw_files = bw_files, qgr = olap_fixedSize, win_size = 100)

# # alternative (2) access the complete data from GEO.  has a tendency to timeout.
# bw_dt = fetchWindowedBigwigList(bw_files = CTCF_in_10a_bigWig_urls, qgr = olap_fixedSize, win_size = 100)
```
[bw load](#bw_load)

```{r, fig.width=16, fig.height=4}
p1 = regionSetPlotBandedQuantiles(bw_dt, hsv_symmetric = T, hsv_reverse = T, hsv_grayscale = T)
p2 = regionSetPlotScatter(bw_dt, x_name = "MCF10A", y_name = "MCF10AT1")
p3 = regionSetPlotHeatmap(bw_dt)
cowplot::plot_grid(p1, p2, p3, nrow = 1)
```

### Retrieve narrowPeak data by url {#np_load}
```{r, eval=FALSE}
# set file urls
url_root = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE98nnn/GSE98551/suppl/"
np_files = paste0(url_root, c("GSE98551_MCF10A_CTCF_pooled_peaks_passIDR.05.narrowPeak.gz",
                              "GSE98551_MCF10AT1_CTCF_pooled_peaks_passIDR.05.narrowPeak.gz",
                              "GSE98551_MCF10CA1_CTCF_pooled_peaks_passIDR.05.narrowPeak.gz")
)
# cleanup names
names(np_files) = np_files %>%
    basename() %>%
    sub("GSE98551_", "", x = .) %>%
    sub("_pooled_peaks_passIDR.05.narrowPeak.gz", "", x = .)

# load peak calls
# from: https://charlesjb.github.io/How_to_import_narrowPeak/
extraCols_narrowPeak <- c(signalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
np_grs <- lapply(np_files, function(f){
    import(f, format = "BED",
           extraCols = extraCols_narrowPeak)
})
#np_grs is now a valid input for overlapIntervalSets()
```

### Retrieve bigwig data by url {#bw_load}
```{r, eval=FALSE}
# set bigwig urls
url_root = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE98nnn/GSE98551/suppl/"
bw_urls = paste0(url_root, c("GSE98551_MCF10A_CTCF_pooled_FE.bw",
                             "GSE98551_MCF10AT1_CTCF_pooled_FE.bw",
                             "GSE98551_MCF10CA1_CTCF_pooled_FE.bw")
)
# cleanup bigwig names
names(bw_urls) = bw_urls %>%
    basename() %>%
    sub("GSE98551_", "", x = .) %>%
    sub("_pooled_FE.bw", "", x = .)
# set bigwig filenames
bw_files = paste0(names(bw_urls), "_FE.bw")
names(bw_files) = names(bw_urls)

# download bigwigs from url to local filename
for(i in seq_along(bw_urls)){
    if(!file.exists(bw_files[i])){
        curl::curl_download(bw_urls[i], destfile = bw_files[i])
    }
}
#bw_files is now a valid input for fetchWindowedBigwigList()
```
