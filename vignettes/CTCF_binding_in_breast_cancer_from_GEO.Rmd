---
title: "CTCF binding in breast cancer cell lines: From GEO"
author: "Joseph R Boyd"
date: "`r Sys.Date()`"
output:
rmarkdown::html_vignette:
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{CTCF binding in breast cancer cell lines: From GEO}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
  ```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

A demonstration of the use of the [seqsetvis](https://github.com/jrboyd/seqsetvis)
package to compare the binding of the transcription factor CTCF across 3 breast 
cancer cell lines.  

This consists of 2 stages:

1. 3-way overlap of CTCF peaks in 3 cell lines to create a single merged regions set with 3 logical attributes.
2. Retrieval of binding profiles around merged regions set.

Both stages are supported by several plotting functions.

## Loading Libraries

```{r, message = F}
    library(seqsetvis)
    library(magrittr)
    library(rtracklayer)
    library(grid)
    library(gridExtra)
```

## Loading narrowPeak files as GRanges

This vignette runs using a small subset of datasets that are publicly available via [GEO](https://www.ncbi.nlm.nih.gov/geo/).  To download the full dataset see: [narrowPeak from GEO](#np_load)

```{r}
#set filepaths
np_files = c(
    system.file("extdata", "MCF10A_CTCF.narrowPeak", package = "seqsetvis"),
    system.file("extdata", "MCF10AT1_CTCF.narrowPeak", package = "seqsetvis"),
    system.file("extdata", "MCF10CA1_CTCF.narrowPeak", package = "seqsetvis")
)

names(np_files) = np_files %>%
    basename() %>%
    sub(".narrowPeak", "", x = .)

# load peak calls
# from: https://charlesjb.github.io/How_to_import_narrowPeak/
extraCols_narrowPeak <- c(signalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
np_grs <- lapply(np_files, function(f){
    import(f, format = "BED",
           extraCols = extraCols_narrowPeak)
})
#np_grs is now a valid input for overlapIntervalSets()
#any list (ideally with names set) of GRanges would be fine.
```

```{r}
olaps = overlapIntervalSets(np_grs)
olaps %>% mcols %>% as.data.frame %>% colSums
```
### Subsetting Operations
##### bound in all 3
```{r}
subset(olaps, MCF10A_CTCF & MCF10AT1_CTCF & MCF10CA1_CTCF) %>% length
```
##### bound in all but MCF10CA1
```{r}
subset(olaps, MCF10A_CTCF & MCF10AT1_CTCF & !MCF10CA1_CTCF) %>% length
```
##### bound in MCF10CA1 (ignores the other 2)
```{r}
subset(olaps, MCF10CA1_CTCF) %>% length
```
### Plotting

##### Total number of hits per sample
```{r, hold = TRUE, fig.align='center'}
p1 = setPlotBars(olaps)
p2 = setPlotPie(olaps)
grid.arrange(p1, p2, nrow = 1, widths = c(1, 2))
```

##### Overlaps between samples

```{r, hold = TRUE, fig.align='center'}
setPlotVenn(olaps)
setPlotEuler(olaps)
setPlotHeatmap(olaps)
```

[bw load](#bw_load)




## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold', fig.cap = "2 random plots."}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:



Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

### Retrieve narrowPeak data by url {#np_load}
```{r, eval=FALSE}
# set file urls
url_root = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE98nnn/GSE98551/suppl/"
np_files = paste0(url_root, c("GSE98551_MCF10A_CTCF_pooled_peaks_passIDR.05.narrowPeak.gz",
                              "GSE98551_MCF10AT1_CTCF_pooled_peaks_passIDR.05.narrowPeak.gz",
                              "GSE98551_MCF10CA1_CTCF_pooled_peaks_passIDR.05.narrowPeak.gz")
)
# cleanup names
names(np_files) = np_files %>%
    basename() %>%
    sub("GSE98551_", "", x = .) %>%
    sub("_pooled_peaks_passIDR.05.narrowPeak.gz", "", x = .)

# load peak calls
# from: https://charlesjb.github.io/How_to_import_narrowPeak/
extraCols_narrowPeak <- c(signalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
np_grs <- lapply(np_files, function(f){
    import(f, format = "BED",
           extraCols = extraCols_narrowPeak)
})
#np_grs is now a valid input for overlapIntervalSets()
```

### Retrieve bigwig data by url {#bw_load}
```{r, eval=FALSE}
# set bigwig urls
url_root = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE98nnn/GSE98551/suppl/"
bw_urls = paste0(url_root, c("GSE98551_MCF10A_CTCF_pooled_FE.bw",
                             "GSE98551_MCF10AT1_CTCF_pooled_FE.bw",
                             "GSE98551_MCF10CA1_CTCF_pooled_FE.bw")
)
# cleanup bigwig names
names(bw_urls) = bw_urls %>%
    basename() %>%
    sub("GSE98551_", "", x = .) %>%
    sub("_pooled_FE.bw", "", x = .)
# set bigwig filenames
bw_files = paste0(names(bw_urls), "_FE.bw")
names(bw_files) = names(bw_urls)

# download bigwigs from url to local filename
for(i in seq_along(bw_urls)){
    if(!file.exists(bw_files[i])){
        curl::curl_download(bw_urls[i], destfile = bw_files[i])
    }
}
#bw_files is now a valid input for fetchWindowedBigwigList()
```
