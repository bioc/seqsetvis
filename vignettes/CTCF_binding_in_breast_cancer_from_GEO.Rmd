---
title: "CTCF binding in breast cancer cell lines: From GEO"
author: "Joseph R Boyd"
date: "`r Sys.Date()`"
output:
rmarkdown::html_vignette:
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{CTCF binding in breast cancer cell lines: From GEO}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

# Abstract
[seqsetvis](https://github.com/jrboyd/seqsetvis) is an R package for the visual
comparison of sets of genomic regions.  This covers straightforward overlaps 
suitable for something like a venn diagram and extends to more sophisticated 
visualization of continous signal data via clustered heatmaps and track-like 
line plots.  All plots produced by seqsetvis are ggplot2 objects and so can be 
easily tweaked according to user requirements.

Although initially designed to focus on peak call sets, seqsetvis accepts any 
data in GRanges format and is therefore flexible enough to work dowstream of 
many genomics tools.  intended to be used after initial data processing and c

This consists of 2 stages:

1. 3-way overlap of CTCF peaks in 3 cell lines to create a single merged regions 
set with 3 logical attributes.
2. Retrieval of binding profiles around merged regions set.

Both stages are supported by several plotting functions.

# Functionality Overview

## Installation and Loading

### From github
One dependency from bioconductor isn't getting installed automatically
```{r, eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("GenomeInfoDbData")
```

Install devtools if needed
```{r, eval=FALSE}
install.packages("devtools")
```

```{r, eval=FALSE}
devtools::install_github("jrboyd/seqsetvis", build_vignettes = TRUE)
```

### Load the library
```{r}
# library(seqsetvis)
```

## Overlap a list of GRanges
Many plotting functions in \code{seqsetvis} require some kind of sets definition.
Sets can be defined in one of several ways.  \code{overlapIntervalSets} creates 
a single GRanges from a list of GRanges
with a membership table as metadata columns defining sets.
```{r}
olaps = overlapIntervalSets(CTCF_in_10a_narrowPeak_grs)
```

```{r}
olaps = overlapIntervalSets(GRangesList(CTCF_in_10a_narrowPeak_grs))
```
## Loading Libraries

```{r, message = FALSE}
# library(seqsetvis)
library(magrittr)
library(rtracklayer)
library(cowplot)
```

## Loading narrowPeak files as GRanges

This vignette runs using a small subset of datasets that are publicly available 
via [GEO](https://www.ncbi.nlm.nih.gov/geo/).  
To download the full dataset see: [narrowPeak from GEO](#np_load)

```{r}
# load 
# set filepaths
np_files = c(
    system.file("extdata", "MCF10A_CTCF_random100.narrowPeak", 
                package = "seqsetvis"),
    system.file("extdata", "MCF10AT1_CTCF_random100.narrowPeak", 
                package = "seqsetvis"),
    system.file("extdata", "MCF10CA1_CTCF_random100.narrowPeak", 
                package = "seqsetvis")
)

names(np_files) = np_files %>%
    basename() %>%
    sub("_CTCF_random100.narrowPeak", "", x = .)

# load peak calls
# from: https://charlesjb.github.io/How_to_import_narrowPeak/
extraCols_narrowPeak <- c(signalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
np_grs <- lapply(np_files, function(f){
    import(f, format = "BED",
           extraCols = extraCols_narrowPeak)
})

# # Alternatively, accesss the full datasets by url.
# np_grs <- lapply(CTCF_in_10a_narrowPeak_urls, function(f){
#     import(f, format = "BED",
#            extraCols = extraCols_narrowPeak)
# })

#np_grs is now a valid input for overlapIntervalSets()
#any list (ideally with names set) of GRanges would be fine.
```

```{r}
olaps = overlapIntervalSets(np_grs)
olaps %>% mcols %>% as.data.frame %>% colSums
```
### Subsetting Operations
##### bound in all 3
```{r}
subset(olaps, MCF10A & MCF10AT1 & MCF10CA1) %>% length
```
##### bound in all but MCF10CA1
```{r}
subset(olaps, MCF10A & MCF10AT1 & !MCF10CA1) %>% length
```
##### bound in MCF10CA1 (ignores the other 2)
```{r}
subset(olaps, MCF10CA1) %>% length
```
### Plotting

##### Total number of hits per sample
```{r, hold = TRUE, fig.align='center', fig.height=3}
p1 = ssvFeatureBars(olaps) +  theme(legend.position = "left")
p2 = ssvFeaturePie(olaps) + guides(fill = "none")
p1 = p1 + theme(axis.text.x = element_blank(), 
                axis.ticks.x = element_blank(),
                legend.justification = "center")
cowplot::ggdraw() +
    cowplot::draw_plot(p1, 0, 0, .58, .7) +
    cowplot::draw_plot(p2, 0.45, 0, 0.65, .8) +
    cowplot::draw_plot_label(c("CTCF binding in breast cancer cell lines", "A", "B"),
                             x = c(.04, .25, 0.65),
                             y = c(.92, .8, .8), size = 15, hjust = 0)
```

##### Overlaps between samples

```{r, hold = TRUE, fig.align='center', fig.width=8, fig.height=4}
p1 = ssvFeatureVenn(olaps)  +
    theme(legend.text = element_text(size = 8), 
          legend.position = "left")
p2 = ssvFeatureEuler(olaps) + 
    theme(legend.text = element_text(size = 8)) + 
    guides(fill = "none", color = "none")
p3 = ssvFeatureBinaryHeatmap(olaps) + 
    theme(axis.text.x = element_text(size = 8)) + 
    labs(title = "")
cowplot::ggdraw() +
    cowplot::draw_plot(p1 + theme(legend.justification = "center"), 0, 0, .47, 1) +
    cowplot::draw_plot(p2, 0.43, 0, 0.3, 1) +
    cowplot::draw_plot(p3, 0.75, 0, .25, 1) +
    cowplot::draw_plot_label(c("CTCF binding in breast cancer cell lines", "A", "B", "C"),
                    x = c(.04, .12, 0.43, .73),
                    y = c(.92, .8, .8, .8), size = 15, hjust = 0)
```

### Prepare overlap ranges for fetching profiles
```{r, fig.height=3}
width_q75 = olaps %>% width() %>% quantile(., .75)
width_q75 = ceiling(width_q75 / 100) * 100
hist_res = hist(width(olaps))
lines(rep(width_q75, 2), c(0, max(hist_res$counts)), col = "red", lwd = 5)
text(width_q75, max(hist_res$counts), "fixedSize", adj = c(-.1, 1), col = "red")
## apply width
olap_fixedSize = centerFixedSizeGRanges(olaps, width_q75)
```

### Fetch profiles
```{r}
bw_dt = CTCF_in_10a_profiles_dt
bw_gr = GRanges(bw_dt)
# reading bigWigs will not work at all on windows. if you are able to read
# bigwigs on your system, consider the following for loading as bigwigs:
# # alternative (1) accessing the subsetted bigwigs included with this package
# bw_files = sapply(names(CTCF_in_10a_bigWig_urls), function(x){
#     system.file("extdata", paste0(x, "_FE_random100.bw"), package = "seqsetvis")
# })
bw_dt = fetchWindowedBigwigList(bw_files = bw_files, qgr = olap_fixedSize,
  win_size = 100)

# # alternative (2) access the complete data from GEO.  has a tendency to timeout.
# bw_dt = fetchWindowedBigwigList(bw_files = CTCF_in_10a_bigWig_urls, 
#     qgr = olap_fixedSize, win_size = 100)
```
[bw load](#bw_load)

```{r, fig.width=16, fig.height=4}
p1 = ssvSignalBandedQuantiles(bw_dt, hsv_symmetric = TRUE, hsv_reverse = TRUE, 
                              hsv_grayscale = TRUE)
p2 = ssvSignalScatterplot(bw_dt, x_name = "MCF10A", y_name = "MCF10AT1")
p3 = ssvSignalHeatmap(bw_dt)
cowplot::plot_grid(p1, p2, p3, nrow = 1)
```

### Retrieve narrowPeak data by url {#np_load}
```{r, eval=FALSE}
# set file urls
np_files = CTCF_in_10a_narrowPeak_urls

# load peak calls
# from: https://charlesjb.github.io/How_to_import_narrowPeak/
extraCols_narrowPeak <- c(signalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
np_grs <- lapply(np_files, function(f){
    import(f, format = "BED",
           extraCols = extraCols_narrowPeak)
})
np_grs
#np_grs is now a valid input for overlapIntervalSets()
```

### Retrieve bigwig data by url {#bw_load}
```{r, eval=FALSE}
# set bigwig urls
bw_urls = CTCF_in_10a_bigWig_urls
system.file("extdata", package = "seqsetvis")
# set bigwig filenames
bw_files = paste0(names(bw_urls), "_FE.bw")
save_dir = system.file("extdata", package = "seqsetvis")
bw_files = paste(save_dir, bw_files, sep = "/")
names(bw_files) = names(bw_urls)
# download bigwigs from url to local filename
for(i in seq_along(bw_urls)){
    if(!file.exists(bw_files[i])){
        curl::curl_download(url = bw_urls[i], destfile = bw_files[i], quiet = F)
    }
}
bw_files
#bw_files is now a valid input for fetchWindowedBigwigList()
```
